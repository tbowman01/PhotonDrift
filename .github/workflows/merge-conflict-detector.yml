name: ğŸ”€ Merge Conflict Detection & Resolution

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to check for conflicts'
        required: false
        default: 'main'
      source_branch:
        description: 'Source branch to check conflicts against'
        required: false
        default: 'develop'

jobs:
  detect-conflicts:
    name: ğŸ” Detect Merge Conflicts
    runs-on: ubuntu-latest
    outputs:
      has_conflicts: ${{ steps.conflict-check.outputs.has_conflicts }}
      conflict_files: ${{ steps.conflict-check.outputs.conflict_files }}
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” Check for merge conflicts
      id: conflict-check
      run: |
        # Determine branches
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
        else
          TARGET_BRANCH="main"
          SOURCE_BRANCH="develop"
        fi
        
        echo "Checking conflicts between $SOURCE_BRANCH and $TARGET_BRANCH"
        
        # Fetch latest changes
        git fetch origin $TARGET_BRANCH:$TARGET_BRANCH
        git fetch origin $SOURCE_BRANCH:$SOURCE_BRANCH
        
        # Attempt merge to detect conflicts
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git checkout $TARGET_BRANCH
        if git merge --no-commit --no-ff $SOURCE_BRANCH 2>&1 | tee merge_output.log; then
          echo "has_conflicts=false" >> $GITHUB_OUTPUT
          echo "conflict_files=" >> $GITHUB_OUTPUT
          git merge --abort 2>/dev/null || true
        else
          # Parse conflicts
          CONFLICT_FILES=$(git status --porcelain | grep '^UU\|^AA\|^DD' | cut -c4- | tr '\n' ',' | sed 's/,$//')
          echo "has_conflicts=true" >> $GITHUB_OUTPUT
          echo "conflict_files=$CONFLICT_FILES" >> $GITHUB_OUTPUT
          git merge --abort 2>/dev/null || true
        fi

    - name: ğŸ“Š Generate conflict report
      if: steps.conflict-check.outputs.has_conflicts == 'true'
      run: |
        cat << 'EOF' > conflict_report.md
        # ğŸš¨ Merge Conflict Report
        
        **Branches:** ${{ github.event.inputs.source_branch || 'develop' }} â†’ ${{ github.event.inputs.target_branch || 'main' }}
        **Detection Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ## ğŸ“ Conflicted Files
        ```
        ${{ steps.conflict-check.outputs.conflict_files }}
        ```
        
        ## ğŸ”§ Resolution Steps Required
        1. **Checkout target branch:** `git checkout ${{ github.event.inputs.target_branch || 'main' }}`
        2. **Start merge:** `git merge ${{ github.event.inputs.source_branch || 'develop' }}`
        3. **Resolve conflicts** in the files listed above
        4. **Test resolution:** `make validate`
        5. **Complete merge:** `git commit`
        
        ## ğŸ¤– Automated Resolution Available
        Run the merge conflict resolver:
        ```bash
        gh workflow run merge-conflict-resolver.yml \
          --field target_branch=${{ github.event.inputs.target_branch || 'main' }} \
          --field source_branch=${{ github.event.inputs.source_branch || 'develop' }}
        ```
        
        EOF

    - name: ğŸ“ Upload conflict report
      if: steps.conflict-check.outputs.has_conflicts == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: merge-conflict-report
        path: conflict_report.md

  create-issue:
    name: ğŸ“‹ Create Conflict Resolution Issue
    runs-on: ubuntu-latest
    needs: detect-conflicts
    if: needs.detect-conflicts.outputs.has_conflicts == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ« Create or update merge conflict issue
      uses: actions/github-script@v7
      with:
        script: |
          const conflictFiles = '${{ needs.detect-conflicts.outputs.conflict_files }}';
          const targetBranch = '${{ github.event.inputs.target_branch || 'main' }}';
          const sourceBranch = '${{ github.event.inputs.source_branch || 'develop' }}';
          
          const issueTitle = `ğŸ”€ Merge Conflicts: ${sourceBranch} â†’ ${targetBranch}`;
          
          const issueBody = `# ğŸš¨ Merge Conflict Detection Alert
          
          **Auto-detected merge conflicts** between \`${sourceBranch}\` and \`${targetBranch}\`.
          
          ## ğŸ“ Conflicted Files
          \`\`\`
          ${conflictFiles.split(',').join('\n')}
          \`\`\`
          
          ## ğŸ”§ Quick Resolution Options
          
          ### Option 1: Automated Resolution
          \`\`\`bash
          gh workflow run merge-conflict-resolver.yml \\
            --field target_branch=${targetBranch} \\
            --field source_branch=${sourceBranch}
          \`\`\`
          
          ### Option 2: Manual Resolution
          1. **Checkout target:** \`git checkout ${targetBranch}\`
          2. **Merge source:** \`git merge ${sourceBranch}\`
          3. **Resolve conflicts** in the files above
          4. **Validate:** \`make validate\`
          5. **Commit:** \`git commit\`
          
          ## ğŸ¯ Common Conflict Types
          - **Cargo.toml:** Usually dependency version conflicts
          - **Dockerfile:** Build argument or instruction conflicts
          - **Makefile:** Target definition conflicts
          - **Source files:** Code logic conflicts
          
          ## ğŸ“Š Resolution Priority
          - ğŸ”´ **High:** Blocking builds or CI
          - ğŸŸ¡ **Medium:** Documentation or configuration
          - ğŸŸ¢ **Low:** Comments or formatting
          
          ---
          *Auto-generated by Merge Conflict Detector*
          *Detection time: ${new Date().toISOString()}*
          `;
          
          // Search for existing issue
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'merge-conflict'
          });
          
          const existingIssue = existingIssues.data.find(issue => 
            issue.title.includes(`${sourceBranch} â†’ ${targetBranch}`)
          );
          
          if (existingIssue) {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: issueBody
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `ğŸ”„ **Conflict Re-detected:** ${new Date().toISOString()}\n\nFiles: \`${conflictFiles}\``
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['merge-conflict', 'automated', 'priority-high']
            });
          }

  notify-team:
    name: ğŸ“¢ Notify Development Team
    runs-on: ubuntu-latest
    needs: [detect-conflicts, create-issue]
    if: needs.detect-conflicts.outputs.has_conflicts == 'true'
    
    steps:
    - name: ğŸ“§ Send notification
      run: |
        echo "ğŸš¨ MERGE CONFLICT DETECTED"
        echo "Branches: ${{ github.event.inputs.source_branch || 'develop' }} â†’ ${{ github.event.inputs.target_branch || 'main' }}"
        echo "Files: ${{ needs.detect-conflicts.outputs.conflict_files }}"
        echo "Issue created for resolution tracking"
        
        # Could integrate with Slack, Discord, or email notifications here
        # Example: curl -X POST $SLACK_WEBHOOK_URL -d "{'text': 'Merge conflict detected...'}"

  prevention-analysis:
    name: ğŸ›¡ï¸ Conflict Prevention Analysis
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“Š Analyze conflict patterns
      run: |
        echo "ğŸ›¡ï¸ Analyzing merge conflict patterns..."
        
        # Analyze git history for conflict-prone files
        git log --merge --name-only --pretty=format: | sort | uniq -c | sort -nr > conflict_prone_files.txt
        
        # Analyze branch divergence
        COMMITS_AHEAD=$(git rev-list --count main..develop)
        COMMITS_BEHIND=$(git rev-list --count develop..main)
        
        echo "Branch divergence analysis:"
        echo "- develop is $COMMITS_AHEAD commits ahead of main"
        echo "- develop is $COMMITS_BEHIND commits behind main"
        
        if [ $COMMITS_AHEAD -gt 10 ] || [ $COMMITS_BEHIND -gt 10 ]; then
          echo "âš ï¸ HIGH DIVERGENCE: Consider more frequent syncing"
        fi
        
        echo "Conflict-prone files (top 10):"
        head -10 conflict_prone_files.txt || echo "No conflict history found"

    - name: ğŸ’¡ Generate prevention recommendations
      run: |
        cat << 'EOF' > prevention_recommendations.md
        # ğŸ›¡ï¸ Merge Conflict Prevention Recommendations
        
        ## ğŸ“Š Current Analysis
        - Branch divergence detected
        - Conflict-prone files identified
        
        ## ğŸ¯ Prevention Strategies
        1. **Frequent Syncing:** Merge mainâ†’develop weekly
        2. **Pre-commit Hooks:** Validate before commits
        3. **Feature Branches:** Use shorter-lived feature branches
        4. **Code Reviews:** Early conflict detection in PRs
        5. **Automated Testing:** Catch integration issues early
        
        ## ğŸ”„ Recommended Automation
        - Weekly developâ†’main sync PRs
        - Daily conflict detection runs
        - PR-based conflict resolution
        - Automated testing after resolution
        
        EOF

    - name: ğŸ“ Upload prevention analysis
      uses: actions/upload-artifact@v4
      with:
        name: conflict-prevention-analysis
        path: |
          conflict_prone_files.txt
          prevention_recommendations.md